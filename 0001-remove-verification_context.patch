From ceb044367bb49aa665ea46b79b2f32380ced5e95 Mon Sep 17 00:00:00 2001
From: Rob9315 <dev.robk@gmail.com>
Date: Sun, 23 Jun 2024 17:45:57 +0200
Subject: [PATCH] remove verification_context

---
 index.js     | 16 ++--------------
 notarize.js  |  6 ------
 transform.js |  1 -
 3 files changed, 2 insertions(+), 21 deletions(-)

diff --git a/index.js b/index.js
index 234b8383..8cf40c6c 100644
--- a/index.js
+++ b/index.js
@@ -259,13 +259,7 @@ function verifyMerkleIntegrity(merkleBranch, verificationHash) {
 
 function verifyPreviousWitness(data, prev) {
   let prevWitnessHash = ""
-  if (data.verification_context.has_previous_witness) {
-    if (!prev.witness) {
-      return [
-        prevWitnessHash,
-        { error_message: "Previous witness data not found" },
-      ]
-    }
+  if (!!prev?.witness) {
     prevWitnessHash = calculateWitnessHash(
       prev.witness.domain_snapshot_genesis_hash,
       prev.witness.merkle_root,
@@ -738,15 +732,9 @@ function verifyFile(data) {
 }
 
 function verifyPreviousSignature(data, previousVerificationData) {
-  if (!data.verification_context.has_previous_signature) {
+  if (!previousVerificationData?.signature) {
     return null
   }
-  if (!previousVerificationData) {
-    return {
-      error_message:
-        "Revision has previous signature, but no previous revision provided to validate",
-    }
-  }
   const prevSignature = previousVerificationData.signature.signature
   const prevPublicKey = previousVerificationData.signature.public_key
   const signatureHash = calculateSignatureHash(prevSignature, prevPublicKey)
diff --git a/notarize.js b/notarize.js
index c1b918da..c7ab37b1 100755
--- a/notarize.js
+++ b/notarize.js
@@ -340,10 +340,6 @@ const getWallet = (mnemonic) => {
 
 const createNewRevision = async (previousRevision, timestamp) => {
   let verificationData = {
-    verification_context: {
-      has_previous_signature: false,
-      has_previous_witness: false,
-    },
     content: { rev_id: 0 },
   }
 
@@ -353,11 +349,9 @@ const createNewRevision = async (previousRevision, timestamp) => {
   if (previousRevision) {
     previousVerificationHash = previousRevision.metadata.verificationHash
     if (previousRevision.signature && previousRevision.signature.signature) {
-      verificationData.verification_context.has_previous_signature = true
       previousSignatureHash = previousRevision.signature.signature_hash
     }
     if (previousRevision.witness) {
-      verificationData.verification_context.hast_previous_witness = true
       previousWitnessHash = previousRevision.witness.witness_hash
     }
   }
diff --git a/transform.js b/transform.js
index 354db9f8..952fd63f 100644
--- a/transform.js
+++ b/transform.js
@@ -27,7 +27,6 @@ function transformMwXmlRevision2PkcJson(rev) {
   }
 
   const out = {
-    verification_context: JSON.parse(verification.verification_context),
     content: {
       rev_id: rev.id,
       content: sortedContentObj,
-- 
2.45.2

